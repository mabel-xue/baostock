# 基本面查询使用指南

## 功能概述

新增的基本面查询功能允许您传入多个上市公司名称或股票代码，查询并输出基本面信息表。该功能基于AkShare数据源实现。

## 主要特性

1. **支持按公司名称查询** - 自动匹配股票代码
2. **支持按股票代码查询** - 直接使用6位股票代码
3. **批量查询** - 一次查询多家公司
4. **自动汇总** - 将多家公司的关键指标整合到一张表
5. **数据导出** - 支持导出为CSV文件

## 安装依赖

确保已安装akshare：

```bash
pip install akshare>=1.10.0
```

## 使用方法

### 方法1: 使用预置示例脚本

#### 示例1: 查询白酒行业基本面

```bash
cd /Users/mabelxue/web+/baostock
python app/query_fundamental.py
```

该脚本会查询以下白酒公司的基本面信息：
- 贵州茅台
- 五粮液
- 泸州老窖
- 山西汾酒
- 洋河股份

#### 示例2: 自定义查询

```bash
python app/query_fundamental_custom.py
```

该脚本演示了两种查询方式：
1. 根据公司名称查询白酒行业
2. 根据股票代码查询银行股

### 方法2: 在代码中使用

#### 2.1 根据公司名称查询

```python
from src.datasource.akshare_datasource import AkShareDataSource
from src.queries.fundamental_query import FundamentalQuery

# 定义要查询的公司名称
company_names = [
    "贵州茅台",
    "五粮液",
    "泸州老窖",
]

# 使用AkShare数据源
with AkShareDataSource() as datasource:
    query = FundamentalQuery(datasource=datasource)
    
    # 查询2024年的基本面数据
    df = query.query_by_names(names=company_names, year=2024)
    
    # 显示结果
    print(df)
    
    # 保存到CSV
    df.to_csv("fundamental_data.csv", index=False, encoding='utf-8-sig')
```

#### 2.2 根据股票代码查询

```python
from src.datasource.akshare_datasource import AkShareDataSource
from src.queries.fundamental_query import FundamentalQuery

# 定义股票代码列表
stock_codes = [
    "600519",  # 贵州茅台
    "000858",  # 五粮液
    "000568",  # 泸州老窖
]

# 使用AkShare数据源
with AkShareDataSource() as datasource:
    query = FundamentalQuery(datasource=datasource)
    
    # 批量查询
    results = query.query_multiple(codes=stock_codes, year=2024)
    
    # 处理结果
    for code, df in results.items():
        if df is not None and not df.empty:
            print(f"\n{code} 的基本面数据:")
            print(df.tail(1))  # 显示最近一期
```

#### 2.3 查询单个公司

```python
from src.datasource.akshare_datasource import AkShareDataSource
from src.queries.fundamental_query import FundamentalQuery

with AkShareDataSource() as datasource:
    query = FundamentalQuery(datasource=datasource)
    
    # 查询贵州茅台的基本面数据
    df = query.query(code="600519", year=2024)
    
    if df is not None and not df.empty:
        # 获取最近一期数据
        latest = df.iloc[-1]
        
        print(f"报告期: {latest.get('报告期', 'N/A')}")
        print(f"净利润: {latest.get('净利润', 'N/A')}")
        print(f"净资产收益率: {latest.get('净资产收益率', 'N/A')}")
        print(f"毛利率: {latest.get('毛利率', 'N/A')}")
```

## 输出数据说明

查询结果包含以下关键指标（具体字段取决于AkShare返回的数据）：

- **股票代码** - 6位股票代码
- **公司名称** - 公司简称
- **报告期** - 财报报告期
- **净利润** / **净利润(亿元)** - 净利润
- **营业总收入** / **营业总收入(亿元)** - 营业收入
- **净资产收益率** / **净资产收益率(%)** - ROE
- **毛利率** / **毛利率(%)** - 毛利率
- **总资产收益率** / **总资产收益率(%)** - ROA
- **资产负债率** / **资产负债率(%)** - 资产负债率
- **每股收益** / **每股收益(元)** - EPS
- **每股净资产** / **每股净资产(元)** - 每股净资产
- **市盈率** / **PE** - 市盈率
- **市净率** / **PB** - 市净率

## 代码结构

### 新增文件

1. **src/queries/fundamental_query.py**
   - `FundamentalQuery` 类 - 基本面查询核心类
   - `query()` - 查询单个公司
   - `query_multiple()` - 批量查询
   - `query_by_names()` - 根据公司名称查询

2. **src/datasource/akshare_datasource.py**
   - 新增 `query_stock_fundamental()` 方法
   - 使用 `stock_financial_analysis_indicator` 接口

3. **app/query_fundamental.py**
   - 预置示例：查询白酒行业基本面

4. **app/query_fundamental_custom.py**
   - 自定义查询示例：演示多种查询方式

## 注意事项

1. **数据源依赖**
   - 该功能依赖AkShare数据源
   - 确保网络连接正常
   - AkShare免费无需token

2. **公司名称匹配**
   - 使用公司简称，如"贵州茅台"而非"贵州茅台酒股份有限公司"
   - 如果匹配失败，会尝试模糊匹配
   - 建议使用股票代码以确保准确性

3. **数据时效性**
   - 数据来自公开财报
   - 季报、年报发布后才会更新
   - 建议查询上一年度或上一季度的数据

4. **性能考虑**
   - 批量查询时会逐个请求
   - 查询大量公司时可能需要一些时间
   - 建议一次查询不超过20家公司

## 常见问题

### Q1: 如何查询最新的基本面数据？

A: 不指定year参数，或指定当前年份：

```python
df = query.query_by_names(names=company_names)  # 查询全部数据
df = query.query_by_names(names=company_names, year=2024)  # 查询2024年
```

### Q2: 如何查询特定行业的公司？

A: 先准备好该行业的公司名称列表或股票代码列表，然后批量查询：

```python
# 科技行业示例
tech_companies = ["中兴通讯", "烽火通信", "紫光股份"]
df = query.query_by_names(names=tech_companies, year=2024)
```

### Q3: 查询结果为空怎么办？

A: 可能的原因：
1. 公司名称不匹配 - 尝试使用股票代码
2. 该年份没有数据 - 尝试查询其他年份
3. 网络问题 - 检查网络连接
4. 数据源问题 - 尝试升级akshare版本

### Q4: 如何自定义输出的指标？

A: 修改 `fundamental_query.py` 中的 `query_by_names()` 方法，在 `indicators` 列表中添加或删除指标。

## 扩展开发

如果需要添加其他数据源支持（如Tushare），可以：

1. 在对应的数据源类中实现 `query_stock_fundamental()` 方法
2. `FundamentalQuery` 会自动支持该数据源
3. 可以使用 `DataSourceManager` 实现多数据源故障转移

示例：

```python
from src.datasource.datasource_manager import DataSourceManager
from src.datasource.akshare_datasource import AkShareDataSource
from src.datasource.tushare_datasource import TushareDataSource
from src.queries.fundamental_query import FundamentalQuery

# 创建数据源管理器
manager = DataSourceManager()
manager.add_datasource(AkShareDataSource())
manager.add_datasource(TushareDataSource(config={'token': 'your_token'}))

# 使用管理器查询（自动故障转移）
query = FundamentalQuery(datasource=manager)
df = query.query_by_names(names=["贵州茅台", "五粮液"])
```

## 技术支持

如有问题，请查看：
- AkShare官方文档: https://akshare.akfamily.xyz/
- 项目README.md
- 示例代码: examples/ 目录
