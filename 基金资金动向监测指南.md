# 基金资金动向监测 - 快速开始指南

## 概述

基于现有的多数据源架构，已实现基金资金动向监测功能，可以定期查看各大基金资金动向，判断机构偏好。

**实现状态**: ✅ 已完成，基于 AkShare（免费）

## 快速开始

### 1. 安装依赖

确保已安装 AkShare：

```bash
pip install akshare pandas
```

或使用项目的 requirements.txt：

```bash
pip install -r requirements.txt
```

### 2. 运行示例

#### 基础示例

```bash
python examples/fund_monitoring_example.py
```

这将演示：
- 获取基金基本信息
- 查询基金持仓
- 分析机构偏好
- 对比基金持仓

#### 定期监测脚本

```bash
python monitor_fund_preferences.py
```

这将：
- 监测前50只基金的资金动向
- 分析机构偏好（最受机构偏好的股票）
- 生成报告并保存到 `output/` 目录

### 3. 在代码中使用

```python
from src.datasource import DataSourceManager
from src.queries.fund_holdings_query import FundHoldingsQuery

# 配置数据源（使用AkShare）
config = {
    'default_source': 'akshare',
    'sources_config': {'akshare': {}}
}

with DataSourceManager(config) as manager:
    query = FundHoldingsQuery(datasource=manager)
    
    # 1. 查询基金基本信息
    fund_basic = query.query_fund_basic()
    print(f"共有 {len(fund_basic)} 只基金")
    
    # 2. 查询单个基金持仓
    holdings = query.query_fund_holdings(fund_code='000001', period=None)
    print(holdings)
    
    # 3. 分析机构偏好（查询前20只基金）
    fund_codes = fund_basic['基金代码'].head(20).tolist()
    preference = query.analyze_institutional_preference(
        fund_codes=fund_codes,
        period=None,
        top_n=20
    )
    print("机构偏好股票 Top 10:")
    print(preference['top_holdings'].head(10))
    
    # 4. 查询机构持仓（特定股票）
    stock_holdings = query.query_institutional_holdings(
        stock_code='600000',
        period=None
    )
    print(stock_holdings)
```

## 核心功能

### 1. 基金基本信息查询

```python
fund_basic = query.query_fund_basic()
```

返回所有基金的基本信息（基金代码、名称、类型等）

### 2. 基金持仓查询

```python
# 单个基金
holdings = query.query_fund_holdings(fund_code='000001', period='2024Q3')

# 批量查询
holdings_dict = query.query_multiple_funds(
    fund_codes=['000001', '000002', '000003'],
    period='2024Q3'
)
```

### 3. 机构偏好分析

```python
preference = query.analyze_institutional_preference(
    fund_codes=['000001', '000002', ...],  # 基金代码列表，None表示查询所有
    period='2024Q3',  # 报告期，None表示最新
    top_n=20  # 返回前N只股票
)

# 结果包含：
# - preference['top_holdings']: 最受机构偏好的股票（按持有基金数量排序）
# - preference['all_holdings']: 所有持仓数据
```

### 4. 基金持仓对比

```python
comparison = query.compare_fund_holdings(
    fund_codes=['000001', '000002', '000003'],
    period='2024Q3'
)
```

对比多个基金的持仓，找出共同持仓和差异。

### 5. 机构持仓查询

```python
holdings = query.query_institutional_holdings(
    stock_code='600000',  # 股票代码
    period='2024Q3'  # 报告期
)
```

查询特定股票被哪些机构持有。

## 设置定时任务

### Linux/Mac (Cron)

编辑 crontab：

```bash
crontab -e
```

添加以下行（每天上午9点运行）：

```
0 9 * * * cd /path/to/baostock && /usr/bin/python3 monitor_fund_preferences.py >> logs/cron.log 2>&1
```

### Windows (任务计划程序)

1. 打开"任务计划程序"
2. 创建基本任务
3. 设置触发器（每天）
4. 设置操作：运行 `monitor_fund_preferences.py`

## 输出文件

运行监测脚本后，会在以下目录生成文件：

- `output/institutional_preference_YYYYMMDD.csv` - 机构偏好分析结果
- `output/fund_report_YYYYMMDD.txt` - 监测报告
- `logs/fund_monitoring_YYYYMMDD.log` - 运行日志

## 机构偏好判断指标

系统会自动分析以下指标：

1. **重仓股重合度** - 多个基金共同持有的股票
2. **持有基金数量** - 某只股票被多少只基金持有
3. **持仓市值** - 机构持仓的总市值（如果有数据）

## 注意事项

1. **数据更新频率**: 
   - 基金持仓数据每季度更新一次
   - 通常有1-2个月的披露延迟
   - 无法实时获取最新持仓

2. **API限制**: 
   - AkShare 可能有请求频率限制
   - 建议批量查询时适当延迟

3. **数据准确性**: 
   - 基金持仓通常只披露前十大重仓股
   - 非全持仓数据

4. **错误处理**: 
   - 如果某个基金数据获取失败，程序会继续处理其他基金
   - 查看日志文件了解详细错误信息

## 常见问题

### Q: 如何获取最新的基金持仓数据？

A: 基金持仓数据每季度披露一次，通常在季度结束后1-2个月。使用 `period=None` 会自动获取最新可用数据。

### Q: 如何查询特定类型的基金？

A: 先使用 `query_fund_basic()` 获取基金列表，然后根据基金类型字段进行筛选。

### Q: 可以查询私募基金吗？

A: 当前实现主要支持公募基金数据。私募基金数据通常不公开披露。

### Q: 如何提高查询速度？

A: 
- 限制查询的基金数量
- 使用批量查询而不是逐个查询
- 适当使用缓存（未来功能）

## 扩展开发

如果需要添加更多分析功能，可以：

1. 扩展 `FundHoldingsQuery` 类，添加新的分析方法
2. 在 `AkShareDataSource` 中添加更多数据源接口
3. 创建新的查询类，继承 `BaseQuery`

## 相关文件

- `src/datasource/base_datasource.py` - 数据源基类（已扩展基金接口）
- `src/datasource/akshare_datasource.py` - AkShare数据源实现（已实现基金接口）
- `src/queries/fund_holdings_query.py` - 基金持仓查询类
- `monitor_fund_preferences.py` - 定期监测脚本
- `examples/fund_monitoring_example.py` - 使用示例
- `FUND_MONITORING_IMPLEMENTATION.md` - 详细实现文档

## 总结

✅ **实现路径**: 基于现有API（AkShare）完全可行

✅ **核心功能**: 
- 基金基本信息查询
- 基金持仓查询
- 机构偏好分析
- 定期监测和报告生成

✅ **使用方式**: 
- 代码调用
- 命令行脚本
- 定时任务

✅ **数据源**: AkShare（免费，无需token）

现在你可以开始使用基金资金动向监测功能了！
