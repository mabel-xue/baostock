# 基本面查询功能 - 新增功能说明

## 概述

本次更新为项目新增了**股票基本面信息查询功能**，支持传入多个上市公司名称或股票代码，批量查询并输出基本面信息汇总表。

## 新增内容

### 1. 核心代码文件

#### 1.1 数据源层 (src/datasource/)

**文件**: `src/datasource/akshare_datasource.py`

**新增方法**: `query_stock_fundamental()`

```python
def query_stock_fundamental(code: str, **kwargs) -> Optional[pd.DataFrame]:
    """
    查询股票基本面信息（财务指标）
    
    Args:
        code: 股票代码（6位数字）
        **kwargs: 其他参数（如year: 年份）
    
    Returns:
        Optional[pd.DataFrame]: 股票基本面数据
    """
```

**功能说明**:
- 使用AkShare的 `stock_financial_analysis_indicator` 接口
- 支持按年份过滤数据
- 返回包含净利润、ROE、毛利率等多维度财务指标

#### 1.2 查询层 (src/queries/)

**新增文件**: `src/queries/fundamental_query.py`

**核心类**: `FundamentalQuery`

**主要方法**:

1. **query()** - 查询单个公司基本面
   ```python
   df = query.query(code="600519", year=2024)
   ```

2. **query_multiple()** - 批量查询多个公司
   ```python
   results = query.query_multiple(codes=["600519", "000858"], year=2024)
   ```

3. **query_by_names()** - 根据公司名称批量查询（核心功能）
   ```python
   df = query.query_by_names(names=["贵州茅台", "五粮液"], year=2024)
   ```

**功能特点**:
- 自动将公司名称匹配到股票代码
- 支持精确匹配和模糊匹配
- 自动提取关键财务指标
- 将多家公司数据汇总为一张表
- 支持多数据源（通过DataSourceManager）

#### 1.3 模块导出更新

**文件**: `src/queries/__init__.py`

新增导出: `FundamentalQuery`

### 2. 应用示例 (app/)

#### 2.1 预置示例

**文件**: `app/query_fundamental.py`

**功能**: 查询白酒行业5家公司的基本面信息

**使用方法**:
```bash
python app/query_fundamental.py
```

#### 2.2 自定义示例

**文件**: `app/query_fundamental_custom.py`

**功能**: 演示两种查询方式
1. 根据公司名称查询白酒行业
2. 根据股票代码查询银行股

**使用方法**:
```bash
python app/query_fundamental_custom.py
```

#### 2.3 简化版示例

**文件**: `app/query_fundamental_simple.py`

**功能**: 不依赖复杂类结构，直接使用akshare接口

**特点**:
- 代码简单，易于理解
- 适合快速使用和学习
- 独立运行，不依赖项目其他模块

**使用方法**:
```bash
python app/query_fundamental_simple.py
```

### 3. 文档

#### 3.1 使用指南

**文件**: `基本面查询使用指南.md`

**内容**:
- 功能概述和特性
- 安装依赖说明
- 详细使用方法（3种方式）
- 输出数据说明
- 代码结构说明
- 常见问题解答
- 扩展开发指南

#### 3.2 README更新

**文件**: `README.md`

**更新内容**:
- 在"功能特性"部分添加基本面查询
- 在"快速开始"部分添加使用示例
- 添加文档链接

#### 3.3 本文档

**文件**: `新增功能说明.md`

**内容**: 本次更新的完整说明

### 4. 测试文件

**文件**: `test_fundamental.py`

**功能**: 测试基本面查询的三种使用方式
1. 单个股票查询
2. 批量查询
3. 根据公司名称查询

## 使用示例

### 示例1: 根据公司名称查询（推荐）

```python
from src.datasource.akshare_datasource import AkShareDataSource
from src.queries.fundamental_query import FundamentalQuery

# 定义要查询的公司
company_names = ["贵州茅台", "五粮液", "泸州老窖"]

# 使用AkShare数据源
with AkShareDataSource() as datasource:
    query = FundamentalQuery(datasource=datasource)
    
    # 查询2024年基本面数据
    df = query.query_by_names(names=company_names, year=2024)
    
    # 显示结果
    print(df)
    
    # 保存到CSV
    df.to_csv("fundamental_data.csv", index=False, encoding='utf-8-sig')
```

### 示例2: 根据股票代码查询

```python
from src.datasource.akshare_datasource import AkShareDataSource
from src.queries.fundamental_query import FundamentalQuery

# 定义股票代码
stock_codes = ["600519", "000858", "000568"]

with AkShareDataSource() as datasource:
    query = FundamentalQuery(datasource=datasource)
    
    # 批量查询
    results = query.query_multiple(codes=stock_codes, year=2024)
    
    # 处理结果
    for code, df in results.items():
        if df is not None and not df.empty:
            print(f"{code}: 查询成功")
```

### 示例3: 使用简化版本

```bash
# 直接运行预置示例
python app/query_fundamental_simple.py
```

## 输出数据

查询结果包含以下关键指标：

| 字段 | 说明 |
|------|------|
| 股票代码 | 6位股票代码 |
| 公司名称 | 公司简称 |
| 报告期 | 财报报告期 |
| 净利润 / 净利润(亿元) | 净利润 |
| 营业总收入 / 营业总收入(亿元) | 营业收入 |
| 净资产收益率 / 净资产收益率(%) | ROE |
| 毛利率 / 毛利率(%) | 毛利率 |
| 总资产收益率 / 总资产收益率(%) | ROA |
| 资产负债率 / 资产负债率(%) | 资产负债率 |
| 每股收益 / 每股收益(元) | EPS |
| 每股净资产 / 每股净资产(元) | 每股净资产 |
| 市盈率 / PE | 市盈率 |
| 市净率 / PB | 市净率 |

*注: 具体字段取决于AkShare返回的数据*

## 技术架构

### 设计模式

1. **适配器模式** - AkShareDataSource适配AkShare接口
2. **工厂模式** - DataSourceFactory创建数据源实例
3. **策略模式** - 不同数据源实现相同接口
4. **模板方法模式** - BaseQuery定义查询流程

### 类图

```
BaseQuery (抽象基类)
    ↑
    |
FundamentalQuery (基本面查询类)
    |
    | 使用
    ↓
BaseDataSource (数据源基类)
    ↑
    |
AkShareDataSource (AkShare数据源)
```

### 数据流

```
用户输入公司名称
    ↓
FundamentalQuery.query_by_names()
    ↓
查询股票基本信息 (获取代码映射)
    ↓
批量查询基本面 (query_multiple)
    ↓
AkShareDataSource.query_stock_fundamental()
    ↓
akshare.stock_financial_analysis_indicator()
    ↓
提取关键指标并汇总
    ↓
返回DataFrame
```

## 依赖要求

### 必需依赖

- Python >= 3.7
- pandas >= 1.3.0
- akshare >= 1.10.0

### 安装方法

```bash
pip install akshare>=1.10.0
```

或使用requirements.txt:

```bash
pip install -r requirements.txt
```

## 兼容性

### 数据源支持

| 数据源 | 是否支持 | 说明 |
|--------|---------|------|
| AkShare | ✅ 支持 | 推荐使用，免费无需token |
| BaoStock | ❌ 不支持 | BaoStock不提供基本面查询接口 |
| Tushare | ⚠️ 待实现 | 可扩展支持 |

### Python版本

- Python 3.7+
- 已测试: Python 3.8, 3.9, 3.10, 3.11

## 注意事项

1. **数据源依赖**
   - 必须使用AkShare数据源
   - 确保网络连接正常
   - AkShare免费无需token

2. **公司名称匹配**
   - 使用公司简称，如"贵州茅台"
   - 支持模糊匹配
   - 建议使用股票代码以确保准确性

3. **数据时效性**
   - 数据来自公开财报
   - 季报、年报发布后才会更新
   - 建议查询上一年度或上一季度数据

4. **性能考虑**
   - 批量查询会逐个请求
   - 查询大量公司需要时间
   - 建议一次不超过20家公司

## 扩展开发

### 添加其他数据源支持

如需支持Tushare等其他数据源：

1. 在对应数据源类中实现 `query_stock_fundamental()` 方法
2. FundamentalQuery会自动支持该数据源
3. 可使用DataSourceManager实现多数据源故障转移

示例:

```python
# 在 tushare_datasource.py 中添加
def query_stock_fundamental(self, code: str, **kwargs):
    # 实现Tushare的基本面查询
    pass
```

### 自定义输出指标

修改 `fundamental_query.py` 中的 `query_by_names()` 方法：

```python
# 在 indicators 列表中添加或删除指标
indicators = [
    '净利润',
    '净资产收益率',
    '毛利率',
    # 添加更多指标...
]
```

## 常见问题

### Q1: 导入akshare时出现浮点异常

A: 这可能是环境问题。建议：
1. 升级akshare: `pip install --upgrade akshare`
2. 使用虚拟环境
3. 使用简化版示例 `query_fundamental_simple.py`

### Q2: 查询结果为空

A: 可能原因：
1. 公司名称不匹配 - 尝试使用股票代码
2. 该年份没有数据 - 尝试其他年份
3. 网络问题 - 检查网络连接

### Q3: 如何查询特定行业

A: 准备该行业的公司名称列表：

```python
tech_companies = ["中兴通讯", "烽火通信", "紫光股份"]
df = query.query_by_names(names=tech_companies, year=2024)
```

## 更新日志

### v1.1.0 (2026-01-26)

**新增功能**:
- ✅ 股票基本面信息查询
- ✅ 根据公司名称批量查询
- ✅ 基本面数据汇总表生成
- ✅ CSV导出功能

**新增文件**:
- src/queries/fundamental_query.py
- app/query_fundamental.py
- app/query_fundamental_custom.py
- app/query_fundamental_simple.py
- 基本面查询使用指南.md
- 新增功能说明.md

**更新文件**:
- src/datasource/akshare_datasource.py
- src/queries/__init__.py
- README.md

## 贡献者

感谢以下贡献者：
- [@mabelxue] - 基本面查询功能开发

## 许可证

MIT License

## 技术支持

如有问题，请：
1. 查看 [基本面查询使用指南.md](基本面查询使用指南.md)
2. 查看 [README.md](README.md)
3. 运行示例代码: `app/query_fundamental_simple.py`
4. 查看AkShare官方文档: https://akshare.akfamily.xyz/
